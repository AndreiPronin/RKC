@model DB.Model.Court.CourtGeneralInformation
<h2>Рассрочка</h2>
<div class="row">
    <div class="col-md-4">
        <label class="col-sm-12 col-form-label">Дата принятия заявления на  реструктуризацию (рассрочку):</label>
        <div class="col-sm-8">
            @Html.TextBoxFor(m => m.CourtInstallmentPlan.DateAcceptanceApplicationRestructuring, new
            {
                @type = "Date",
                @NotMaxDAte = "true",
                @readonly = "readonly",
                @class = "form-control",
           @Value = (Model.CourtInstallmentPlan.DateAcceptanceApplicationRestructuring.HasValue ? Model.CourtInstallmentPlan.DateAcceptanceApplicationRestructuring.Value.ToString("yyyy-MM-dd") : string.Empty)
       })
        </div>
        <label class="col-sm-12 col-form-label">Сумма рассрочки всего:</label>
        <div class="col-sm-8">
            @Html.TextBoxFor(m => m.CourtInstallmentPlan.AmountRestructuring, new { @readonly = "readonly", @class = "form-control", @Value = Model.CourtInstallmentPlan.AmountRestructuring })
        </div>
        <label class="col-sm-12 col-form-label">Начальный месяц реструктуризации:</label>
        <div class="col-sm-8">
            @Html.TextBoxFor(m => m.CourtInstallmentPlan.StartingMonthRestructuring, new
            {
                @type = "Date",
                @readonly = "readonly",
                @class = "form-control",
           @Value = (Model.CourtInstallmentPlan.StartingMonthRestructuring.HasValue ? Model.CourtInstallmentPlan.StartingMonthRestructuring.Value.ToString("yyyy-MM-dd") : string.Empty)
       })
        </div>
        <label class="col-sm-12 col-form-label">Конечный месяц реструктуризации:</label>
        <div class="col-sm-8">
            @Html.TextBoxFor(m => m.CourtInstallmentPlan.FinalMonthRestructuring, new
            {
                @type = "Date",
                @readonly = "readonly",
                @class = "form-control",
           @Value = (Model.CourtInstallmentPlan.FinalMonthRestructuring.HasValue ? Model.CourtInstallmentPlan.FinalMonthRestructuring.Value.ToString("yyyy-MM-dd") : string.Empty)
       })
        </div>
        <label class="col-sm-12 col-form-label">Дата начала платежей:</label>
        <div class="col-sm-8">
            @Html.TextBoxFor(m => m.CourtInstallmentPlan.DateStartPayment, new
            {
                @type = "Date",
                @readonly = "readonly",
                @class = "form-control",
           @Value = (Model.CourtInstallmentPlan.DateStartPayment.HasValue ? Model.CourtInstallmentPlan.DateStartPayment.Value.ToString("yyyy-MM-dd") : string.Empty)
       })
        </div>
        <label class="col-sm-12 col-form-label">Дата окончания платежей:</label>
        <div class="col-sm-8">
            @Html.TextBoxFor(m => m.CourtInstallmentPlan.DateEndPayment, new
            {
                @type = "Date",
                @NotMaxDAte = "true",
                @readonly = "readonly",
                @class = "form-control",
           @Value = (Model.CourtInstallmentPlan.DateEndPayment.HasValue ? Model.CourtInstallmentPlan.DateEndPayment.Value.ToString("yyyy-MM-dd") : string.Empty)
       })
        </div>
        <label class="col-sm-12 col-form-label">Сумма ежемесячного платежа по реструктуризации:</label>
        <div class="col-sm-8">
            @Html.TextBoxFor(m => m.CourtInstallmentPlan.AmountMonthlyRestructuringPayment, new { @readonly = "readonly", @type = "number", @step = "0.01", @class = "form-control", @Value = Model.CourtInstallmentPlan.AmountMonthlyRestructuringPayment })
        </div>

        <label class="col-sm-12 col-form-label">Примечание:</label>
        <div class="col-sm-8">
            @Html.TextBoxFor(m => m.CourtInstallmentPlan.Comment, new { @readonly = "readonly", @class = "form-control", @Value = Model.CourtInstallmentPlan.Comment })
        </div>
    </div>
    <div class="col-md-4">
        <label style="padding-top: 25px;" class="col-sm-12 col-form-label"> <button type="button" id="AddInstallmentPayRequisites" class="btn btn-primary hidden">Добавление оплат по реструктуризации</button></label>
        <div id="PartialInstallmentPayRequisites">
            @Html.Partial("PartialViewInstallmentPayRequisites", Model.InstallmentPayRequisites)
        </div>
        <label class="col-sm-12 col-form-label">Сумма оплаты по реструктуризации:</label>
        <div class="col-sm-8">
            @Html.TextBoxFor(m => m.CourtInstallmentPlan.AmountPaymentRestructuring, new { @disabled = "disabled", @class = "form-control", @Value = Model.CourtInstallmentPlan.AmountPaymentRestructuring })
        </div>
        <label class="col-sm-12 col-form-label">Остаток суммы по реструктуризации:</label>
        <div class="col-sm-8">
            @Html.TextBoxFor(m => m.CourtInstallmentPlan.RemainderAmountPaymentRestructuring, new { @disabled = "disabled", @class = "form-control", @Value = Model.CourtInstallmentPlan.RemainderAmountPaymentRestructuring })
        </div>
    </div>
</div>
<script>
    function func(e) {
        if (e.value.indexOf(".") != '-1') {
            e.value = e.value.substring(0, e.value.indexOf(".") + 3); // цифра 4, устанавливает количество цифр после запятой,
            e.value = e.value.toString().replace(",", ".");
            //т.е. если 4, то максимум 3 цифры после запятой
            console.log(e.value.toString().replace(",", "."));
        }
    }
   
    $(document).ready(function (e) {
        let summCourtWork = $("#CourtInstallmentPlan_AmountRestructuring").val() - $("#CourtInstallmentPlan_AmountPaymentRestructuring").val();
        $("#CourtInstallmentPlan_RemainderAmountPaymentRestructuring").val(summCourtWork);

        $("#CourtInstallmentPlan_AmountRestructuring").on("click keyup change focus " ,function () {
            let summCourtWork = $("#CourtInstallmentPlan_AmountRestructuring").val() - $("#CourtInstallmentPlan_AmountPaymentRestructuring").val();
            $("#CourtInstallmentPlan_RemainderAmountPaymentRestructuring").val(summCourtWork);
        })
       
        $("#AddInstallmentPayRequisites").click(function (e) {
            var Date = "@DateTime.Now.Date.AddMonths(-1).ToString("yyyy-MM")";
            var DateMax = "@DateTime.Now.AddMonths(-1).ToString("yyyy-MM")";
            console.log(DateMax);
            $.confirm({
                title: 'Внести оплату',
                content: '' +
                    '<form action="" class="formName">' +
                    '<div class="col-md-6">' +
                    '<label>Дата</label>' +
                    '<input type="Date" id="DateInstallmentPayRequisites" class="form-control" />' +
                    '</div>' +
                    '<div class="col-md-6">' +
                    '<label>Сумма</label>' +
                    '<input type="number" id="SumInstallmentPayRequisites" oninput="func(this)" class="form-control" />' +
                    '</div>' +
                    '</form>',
                buttons: {
                    '<input type="button" class="btn btn-primary" value="Сохранить" data-toggle="modal" data-target="#ShowLogResultModal" />': function () {
                        var summa = $("#SumInstallmentPayRequisites").val();
                        summa = summa.replace(",", ".")
                        $.ajax({
                            url: '/Court/AddInstallmentPayRequisites',
                            type: 'Post',
                            async: false,
                            data: JSON.stringify({
                                installmentPayRequisites: {
                                    CourtGeneralInformId:@Model.Id,
                                    Date: $("#DateInstallmentPayRequisites").val(),
                                    Suma: summa,
                                }
                            }),
                            contentType: 'application/json; charset=utf-8',
                            success: function (data) {
                                UpdateInstallmentPayRequisites();
                                let summCourtWork = $("#CourtInstallmentPlan_RemainderAmountPaymentRestructuring").val() - summa;
                                $("#CourtInstallmentPlan_RemainderAmountPaymentRestructuring").val(summCourtWork);
                            },
                            error: function () {
                                alert("Что то пошло не так. Обратитесь к администратору");
                            }
                        });
                    },
                    "Отмена": function () {

                    }
                }
            })

        });

    })
</script>
